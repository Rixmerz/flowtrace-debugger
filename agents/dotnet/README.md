# FlowTrace .NET Agent

**Compile-time tracing for .NET applications with Source Generator-based automatic instrumentation**

[![.NET Version](https://img.shields.io/badge/.NET-8.0+-purple.svg)](https://dotnet.microsoft.com/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

Comprehensive distributed tracing agent for .NET with support for ASP.NET Core, Minimal API, and Entity Framework Core. Automatically traces function calls, HTTP requests, and database queries with zero runtime overhead.

## Features

- ✅ **Compile-Time Instrumentation**: Roslyn Source Generator for zero runtime overhead
- ✅ **[Trace] Attribute**: Simple attribute-based method tracing
- ✅ **ASP.NET Core Middleware**: HTTP request/response tracking with request_id
- ✅ **Entity Framework Interceptor**: Database query tracing with SQL and parameters
- ✅ **Async/Await Support**: Full support for Task<T> and async methods
- ✅ **JSONL Output**: Compatible with FlowTrace MCP Server format
- ✅ **CLI Tool**: flowctl-dotnet for code analysis and auto-instrumentation
- ✅ **Production Ready**: Thread-safe, low overhead, configurable

## Table of Contents

- [Installation](#installation)
- [Quick Start](#quick-start)
- [Usage Modes](#usage-modes)
- [Framework Integration](#framework-integration)
- [CLI Tool](#cli-tool)
- [Configuration](#configuration)
- [Advanced Usage](#advanced-usage)
- [Examples](#examples)
- [Performance](#performance)
- [API Reference](#api-reference)

## Installation

### Using NuGet

```bash
dotnet add package Flowtrace.Agent
```

### From Source

```bash
git clone https://github.com/Rixmerz/flowtrace-debugger.git
cd flowtrace/agents/dotnet
dotnet build
```

## Quick Start

### 1. Add [Trace] Attribute

```csharp
using Flowtrace.Agent;

public partial class Calculator
{
    [Trace]
    public int Add(int x, int y)
    {
        return x + y;
    }

    [Trace]
    public async Task<string> FetchDataAsync(string url)
    {
        await Task.Delay(100);
        return $"Data from {url}";
    }
}
```

### 2. Configure FlowTrace

```csharp
using Flowtrace.Agent;

var config = new FlowtraceConfig
{
    LogFile = "flowtrace.jsonl",
    WriteToConsole = true
};

FlowtraceTracer.Configure(config);
```

### 3. Call Instrumented Methods

```csharp
var calculator = new Calculator();

// Call the *Traced version generated by Source Generator
var sum = calculator.AddTraced(5, 3);

// The Source Generator automatically creates:
// public int AddTraced(int x, int y) { /* instrumentation code */ }
```

### 4. Build Project

```bash
dotnet build
```

The Source Generator runs at compile-time and creates instrumented wrapper methods.

### 5. View Trace Output

```json
{"timestamp":1705318200000,"event":"ENTER","thread":"42","class":"Calculator","function":"Add","args":"{\"x\":5,\"y\":3}"}
{"timestamp":1705318200005,"event":"EXIT","thread":"42","class":"Calculator","function":"Add","result":"8","durationMicros":5000,"durationMillis":5}
```

## Usage Modes

### 1. Source Generator (Compile-Time)

**Best for**: Production, zero runtime overhead

```csharp
public partial class ProductService  // Must be partial
{
    [Trace]
    public async Task<Product> GetProductAsync(int id)
    {
        // Method implementation
        return await _database.QueryAsync(id);
    }
}

// At compile-time, Source Generator creates:
// public async Task<Product> GetProductAsyncTraced(int id) { /* instrumentation */ }

// Usage:
var product = await service.GetProductAsyncTraced(123);
```

**Pros**: Zero runtime overhead, type-safe, IntelliSense support
**Cons**: Requires partial classes, *Traced method naming convention

### 2. [TraceIgnore] Attribute

Exclude specific methods or classes from tracing:

```csharp
[TraceIgnore]
public int InternalHelper(int value)
{
    // This method will NOT be traced
    return value * 2;
}
```

## Framework Integration

### ASP.NET Core

```csharp
using Flowtrace.Agent;
using Flowtrace.Agent.AspNetCore;

var builder = WebApplication.CreateBuilder(args);

// Configure FlowTrace
var flowtraceConfig = new FlowtraceConfig
{
    LogFile = "flowtrace.jsonl",
    WriteToConsole = true
};
FlowtraceTracer.Configure(flowtraceConfig);

var app = builder.Build();

// Add FlowTrace middleware
app.UseFlowtrace();

app.MapGet("/api/products", async (ProductService service) =>
{
    var products = await service.GetAllProductsAsyncTraced();
    return Results.Ok(products);
});

app.Run();
```

**HTTP Request Event**:
```json
{
  "timestamp": 1705318200000,
  "event": "HTTP_REQUEST",
  "thread": "42",
  "metadata": {
    "request_id": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
    "method": "GET",
    "path": "/api/products",
    "remote_addr": "127.0.0.1",
    "user_agent": "Mozilla/5.0..."
  }
}
```

**HTTP Response Event**:
```json
{
  "timestamp": 1705318200080,
  "event": "HTTP_RESPONSE",
  "thread": "42",
  "metadata": {
    "request_id": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
    "method": "GET",
    "path": "/api/products",
    "status_code": 200,
    "duration_millis": 80
  }
}
```

### Entity Framework Core

```csharp
using Flowtrace.Agent.EntityFramework;
using Microsoft.EntityFrameworkCore;

services.AddDbContext<MyDbContext>(options =>
    options.UseSqlServer(connectionString)
           .AddFlowtrace());  // Add FlowTrace interceptor
```

**Database Query Event**:
```json
{
  "timestamp": 1705318200050,
  "event": "DB_QUERY",
  "thread": "42",
  "metadata": {
    "sql": "SELECT * FROM Products WHERE Id = @p0",
    "parameters": {"@p0": 123},
    "duration_millis": 15,
    "command_type": "Text"
  }
}
```

## CLI Tool

### flowctl-dotnet

Command-line tool for analyzing C# projects and auto-instrumenting code.

#### Installation

```bash
cd flowctl-dotnet
dotnet build
```

#### Commands

**Analyze Project**:
```bash
dotnet run -- analyze ../examples
```

**Auto-Instrument File**:
```bash
dotnet run -- instrument MyService.cs --dry-run  # Preview
dotnet run -- instrument MyService.cs            # Apply
```

**Validate Setup**:
```bash
dotnet run -- validate
```

**Show Version**:
```bash
dotnet run -- version
```

See [flowctl-dotnet/README.md](flowctl-dotnet/README.md) for complete documentation.

## Configuration

### Via Code

```csharp
var config = new FlowtraceConfig
{
    LogFile = "flowtrace.jsonl",   // Output file
    WriteToConsole = true           // Also log to console
};

FlowtraceTracer.Configure(config);
```

### Via Environment Variables

```bash
export FLOWTRACE_LOGFILE=flowtrace.jsonl
export FLOWTRACE_CONSOLE=true
```

## Advanced Usage

### Trace Attribute Options

```csharp
[Trace(OperationName = "CustomOperation", IncludeArguments = false, IncludeResult = false)]
public int Calculate(int x, int y)
{
    return x + y;
}
```

### Manual Event Logging

```csharp
FlowtraceTracer.LogEvent(new TraceEvent
{
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds(),
    Event = "CUSTOM_EVENT",
    Thread = Environment.CurrentManagedThreadId.ToString(),
    Metadata = new Dictionary<string, object>
    {
        ["key"] = "value"
    }
});
```

### Error Handling

Exceptions are automatically captured:

```csharp
[Trace]
public int Divide(int x, int y)
{
    return x / y;  // DivideByZeroException logged automatically
}
```

**Exception Event**:
```json
{
  "timestamp": 1705318200100,
  "event": "EXCEPTION",
  "thread": "42",
  "class": "Calculator",
  "function": "Divide",
  "exception": "System.DivideByZeroException: Attempted to divide by zero",
  "durationMicros": 1500,
  "durationMillis": 1
}
```

## Examples

Complete working examples available in [`examples/`](examples/):

### 1. SimpleExample ([examples/SimpleExample/](examples/SimpleExample/))

- Basic [Trace] attribute usage
- Sync and async methods
- Exception handling
- **100 LOC**

### 2. AspNetCoreAdvanced ([examples/AspNetCoreAdvanced/](examples/AspNetCoreAdvanced/))

- Complete REST API with CRUD operations
- Database simulation with async operations
- HTTP middleware with request_id tracking
- Validation and error handling
- **350+ LOC**

### 3. MinimalApiRealtime ([examples/MinimalApiRealtime/](examples/MinimalApiRealtime/))

- WebSocket chat application
- Real-time message broadcasting
- Room management with concurrent clients
- **330+ LOC**

### 4. Microservice ([examples/Microservice/](examples/Microservice/))

- Production service architecture
- Cache, Database, Logger, Product, Order, Workflow services
- Dependency injection
- Cache-aside pattern
- Multi-step purchase workflow
- **380+ LOC**

## Performance

### Overhead Measurements

| Mode | Overhead | Use Case |
|------|----------|----------|
| Source Generator | 0μs compile-time | Production (zero runtime overhead) |
| [Trace] Attribute | ~0.1-0.5μs per call | Attribute application |
| HTTP Middleware | ~100-200μs per request | All environments |
| EF Interceptor | ~50-100μs per query | Database operations |

### Optimization Tips

1. **Partial Classes**: Required for Source Generator to work
   ```csharp
   public partial class ProductService  // Must be partial
   ```

2. **Selective Instrumentation**: Only trace critical methods
   ```csharp
   [Trace]  // Only trace important methods
   public async Task<Product> GetProductAsync(int id)
   ```

3. **Use [TraceIgnore]**: Skip internal helpers
   ```csharp
   [TraceIgnore]
   private int InternalCalculation(int value)
   ```

## API Reference

### Core Classes

#### `FlowtraceConfig`

Configuration for FlowTrace agent.

```csharp
public class FlowtraceConfig
{
    public string LogFile { get; set; } = "flowtrace.jsonl";
    public bool WriteToConsole { get; set; } = false;
}
```

#### `FlowtraceTracer`

Global tracer for logging events.

```csharp
public static class FlowtraceTracer
{
    public static void Configure(FlowtraceConfig config);
    public static void LogEvent(TraceEvent traceEvent);
    public static void Shutdown();
}
```

#### `TraceEvent`

Represents a trace event.

```csharp
public class TraceEvent
{
    public static TraceEvent Enter(string className, string methodName, Dictionary<string, object>? args);
    public static TraceEvent Exit(string className, string methodName, object? result, double durationMicros);
    public static TraceEvent Exception(string className, string methodName, string exception, double durationMicros);
}
```

### Attributes

#### `[Trace]`

Mark methods for automatic instrumentation.

```csharp
[AttributeUsage(AttributeTargets.Method)]
public class TraceAttribute : Attribute
{
    public string? OperationName { get; set; }
    public bool IncludeArguments { get; set; } = true;
    public bool IncludeResult { get; set; } = true;
}
```

#### `[TraceIgnore]`

Exclude methods or classes from tracing.

```csharp
[AttributeUsage(AttributeTargets.Method | AttributeTargets.Class)]
public class TraceIgnoreAttribute : Attribute
{
}
```

### Middleware

#### `FlowtraceMiddleware`

ASP.NET Core middleware for HTTP tracing.

```csharp
app.UseFlowtrace();
```

### Interceptors

#### `FlowtraceDbInterceptor`

Entity Framework Core interceptor for database query tracing.

```csharp
options.UseSqlServer(connectionString)
       .AddFlowtrace();
```

## Output Format

All events are logged in JSONL format compatible with FlowTrace MCP Server:

### Function Entry (ENTER)

```json
{
  "timestamp": 1705318200000,
  "event": "ENTER",
  "thread": "42",
  "class": "ProductService",
  "function": "GetProductAsync",
  "args": "{\"id\":123}"
}
```

### Function Exit (EXIT)

```json
{
  "timestamp": 1705318200070,
  "event": "EXIT",
  "thread": "42",
  "class": "ProductService",
  "function": "GetProductAsync",
  "result": "{\"id\":123,\"name\":\"Laptop\",\"price\":999.99}",
  "durationMicros": 70000,
  "durationMillis": 70
}
```

### Exception (EXCEPTION)

```json
{
  "timestamp": 1705318200100,
  "event": "EXCEPTION",
  "thread": "42",
  "class": "Calculator",
  "function": "Divide",
  "exception": "System.DivideByZeroException: Attempted to divide by zero",
  "durationMicros": 1500,
  "durationMillis": 1
}
```

## Testing

Run the test suite:

```bash
cd Flowtrace.Agent.Tests
dotnet test
```

Test files:
- `TraceAttributeTests.cs` - Attribute tests
- `ConfigTests.cs` - Configuration tests
- `LoggerTests.cs` - Logger tests
- `TracerTests.cs` - Global tracer tests
- `TraceEventTests.cs` - Event factory tests

## Architecture

```
Flowtrace.Agent/
├── TraceAttribute.cs                 # [Trace] and [TraceIgnore] attributes
├── FlowtraceConfig.cs                # Configuration class
├── FlowtraceLogger.cs                # JSONL logger (thread-safe)
├── FlowtraceTracer.cs                # Global tracer
├── TraceEvent.cs                     # Event model
├── AspNetCore/
│   └── FlowtraceMiddleware.cs        # HTTP middleware
└── EntityFramework/
    └── FlowtraceDbInterceptor.cs     # EF Core interceptor

Flowtrace.Agent.SourceGenerator/
└── FlowtraceSourceGenerator.cs       # Roslyn Source Generator

flowctl-dotnet/
├── Program.cs                        # CLI entry point
├── Analyzer.cs                       # Roslyn code analysis
└── Instrumenter.cs                   # Auto-instrumentation

examples/
├── SimpleExample/
├── AspNetCoreAdvanced/
├── MinimalApiRealtime/
└── Microservice/

Flowtrace.Agent.Tests/
└── *.cs                              # xUnit tests
```

## Comparison with Other Agents

| Feature | .NET | Python | Go | Rust |
|---------|------|--------|-----|------|
| Instrumentation | Source Generator | Decorator | Comment directive | Proc Macro |
| Timing | Compile-time | Runtime | Compile-time | Compile-time |
| Overhead | Zero runtime | Minimal | Zero runtime | Zero runtime |
| Async Support | ✅ Task<T> | ✅ async/await | ✅ goroutines | ✅ async/await |
| Setup | [Trace] attribute | @trace decorator | //trace comment | #[trace] attribute |
| CLI Tool | ✅ flowctl-dotnet | ✅ flowctl-py | ✅ flowctl | ✅ flowctl-rs |
| Framework Support | ✅ ASP.NET, EF | ✅ Flask, FastAPI, Django | ✅ Gin, Echo, Chi | ✅ Actix, Rocket |
| HTTP Context | ✅ Request ID | ✅ Request ID | ✅ Request ID | ✅ Request ID |
| Tests | ✅ xUnit | ✅ pytest | ✅ go test | ✅ Cargo test |
| Status | ✅ 100% | ✅ 100% | ✅ 100% | ✅ 100% |

## Roadmap

- [x] Core [Trace] attribute and TraceIgnore
- [x] Roslyn Source Generator (compile-time instrumentation)
- [x] JSONL logger (thread-safe)
- [x] Configuration system
- [x] ASP.NET Core middleware
- [x] Entity Framework Core interceptor
- [x] CLI tool (flowctl-dotnet)
- [x] Complete test suite (xUnit)
- [x] Advanced examples (4 examples)
- [x] HTTP context tracking (request_id)
- [x] Complete documentation
- [ ] Sampling strategies
- [ ] Distributed tracing (trace propagation)
- [ ] Metrics collection
- [ ] Performance profiling integration

## Contributing

Contributions welcome! Please see [CONTRIBUTING.md](../../CONTRIBUTING.md) for guidelines.

## License

MIT License - See [LICENSE](../../LICENSE) for details.

## Support

- **Documentation**: [FlowTrace Docs](https://github.com/Rixmerz/flowtrace-debugger)
- **Issues**: [GitHub Issues](https://github.com/Rixmerz/flowtrace-debugger/issues)
- **Discussions**: [GitHub Discussions](https://github.com/Rixmerz/flowtrace-debugger/discussions)

---

**Made with ⚡ by the FlowTrace Team**
